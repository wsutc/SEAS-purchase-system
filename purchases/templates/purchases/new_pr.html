{% extends "purchases/layout.html" %}
{% comment %} {% load crispy_forms_tags %} {% endcomment %}
{% load static %}
{% block title %}Create Purchase Request{% endblock %}
{% block content %}

{% comment %} {% crispy form %} {% endcomment %}

{% comment %} <div class="container">
    <div class="card">
        <div class="card-header">
            Create Purchase Request
        </div>
        <div class="card-body">
             {% crispy form %}
        </div>
    </div>
</div> {% endcomment %}

<style>
    .hidden {
        display: none
    }

    .currency {
        width: 5em;
    }

    .quantity {
        width: 4em;
    }
</style>

<div class="container mt-4">
    <form method="post">
        {% csrf_token %}
        <div class="card col">
            <div class="card-header">
                <h4>Create <span class="header-em">Purchase Request</span></h4>
            </div>
            <div class="card-body">
                {{ form.non_form_errors }}
                <table>
                    {{ form.as_table }}
                </table>
                <p class="h1 text-info">Account(s)</p>
                {{ purchase_request_accounts_formset.non_form_errors }}
                {{ purchase_request_accounts_formset.management_form }}
                <table id="account-table" class="table table-striped">
                    <thead class="text-bg-secondary text-center">
                        <td>Account</td>
                        <td>Spend Category</td>
                        <td class="col-2">Dist Type</td>
                        <td class="col-1">Distribution</td>
                        <td>Delete</td>
                    </thead>
                    <tbody id="account-table-body" class="{{ purchase_request_accounts_formset.prefix }}">
                        {% for account in purchase_request_accounts_formset %}
                            {{ account.id }}
                            <tr class="account-row">
                                <td>{{ account.accounts }}</td>
                                <td>{{ account.spend_category }}</td>
                                <td>{{ account.distribution_type }}</td>
                                <td>{{ account.distribution_input }}</td>
                                <td>{{ account.DELETE }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <table class="hidden">
                    <tr id="empty-account-row">
                        <td>{{ purchase_request_accounts_formset.empty_form.accounts }}</td>
                        <td>{{ purchase_request_accounts_formset.empty_form.spend_category }}</td>
                        <td>{{ purchase_request_accounts_formset.empty_form.distribution_type }}</td>
                        <td>{{ purchase_request_accounts_formset.empty_form.distribution_input }}</td>
                        <td>{{ purchase_request_accounts_formset.empty_form.DELETE }}</td>
                    </tr>
                </table>
                <button id="add-account" type="button" class="btn btn-secondary"><i class="fa-solid fa-plus"></i></button>

                {% comment %} <p>Sales Tax: {{ form.sales_tax_rate }}</p> {% endcomment %}
                
                <p class="h1 text-info">Add Items</p>
                {{ purchase_request_items_formset.non_form_errors }}
                {{ purchase_request_items_formset.management_form }}
                <table id="item-table" class="table table-striped">
                    <thead class="text-bg-secondary">
                        <td>Name/Description</td>
                        <td class="col-2">Identifier</td>
                        <td class="col-3">Link</td>
                        <td class="col-1">Unit Price</td>
                        <td class="col-1">Quantity</td>
                        <td class="col-1">Unit</td>
                        <td>Delete</td>
                    </thead>
                    <tbody id="item-table-body" class="{{ purchase_request_items_formset.prefix }}">
                        {% for form in purchase_request_items_formset %}
                            {{ form.id }}
                            <tr class="item-row">
                                <td>{{ form.name }}</td>
                                <td>{{ form.identifier }}</td>
                                <td>{{ form.link }}</td>
                                <td>{{ form.unit_price }}</td>
                                <td>{{ form.quantity }}</td>
                                <td>{{ form.unit }}</td>
                                <td>{{ form.DELETE }}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <table class="hidden">
                    <tr id="empty-row">
                        <td>{{ purchase_request_items_formset.empty_form.name }}</td>
                        <td>{{ purchase_request_items_formset.empty_form.identifier }}</td>
                        <td>{{ purchase_request_items_formset.empty_form.link }}</td>
                        <td>{{ purchase_request_items_formset.empty_form.unit_price }}</td>
                        <td>{{ purchase_request_items_formset.empty_form.quantity }}</td>
                        <td>{{ purchase_request_items_formset.empty_form.unit }}</td>
                        <td>{{ purchase_request_items_formset.empty_form.DELETE }}</td>
                    </tr>
                </table>
                {% comment %} <button id="add-item" class="btn btn-primary" type="button" name="button">Add Item</button> {% endcomment %}
                {% comment %} <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#exampleModal">Add Item</button> {% endcomment %}
                <button id="add-item" type="button" class="btn btn-secondary"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>
        <div class="mt-3 mb-5">
            <button type="submit" class="save btn btn-primary">Save</button>
        </div>
    </form>
    {% comment %} <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">Modal</button> {% endcomment %}
</div>

{% comment %} <div class="modal" tabindex="-1" id="exampleModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="name">Name</label>
                        <input type="text" class="form-control" id="name" placeholder="Starship">
                    </div>
                    <div class="mb-3">
                        <label for="manufacturer" class="form-label">Manufacturer</label>
                        <input type="text" class="form-control" id="manufacturer" placeholder="SpaceX">
                    </div>
                    <div class="mb-3">
                        <label for="identifier" class="form-label">Manufacturer Part Number (if known)</label>
                        <input type="text" class="form-control" id="identifier" placeholder="123456789">
                    </div>
                    <div class="mb-3">
                        <label for="link" class="form-label">Direct Link</label>
                        <input type="url" class="form-control" id="link" placeholder="https://www.spacex.com/vehicles/starship/">
                    </div>
                    <div class="mb-3">
                        <label for="price" class="form-label">Price</label>
                        <input type="number" class="form-control" id="price" placeholder="10,000,000">
                    </div>
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="quantity" placeholder="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="{% url 'add_item_modal' %}" class="btn btn-primary">Add</a>
                {% comment %} <button type="button" id="add-item" class="btn btn-primary" data-bs-dismiss="modal">Add</button>
            </div>
        </div>
    </div>
</div> {% endcomment %}


    {% comment %} <script src="{% static 'js/bootstrap.js' %}"></script>
    <script src="{% static 'js/jquery.js' %}"></script>
    <script src="{% static 'js/jquery.bootstrap.modal.forms.js' %}"></script> {% endcomment %}
    <!-- You can alternatively load the minified version -->
    {% comment %} <script src="{% static 'js/jquery.bootstrap.modal.forms.min.js' %}"></script> {% endcomment %}


{% comment %} <div class="modal fade" tabindex="-1" role="dialog" id="modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content"></div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function() {
        $("#add-item").modalForm({
            formURL: "{% url 'add_item_modal' %}"
        });
    });
</script> {% endcomment %}

<script>
    const addRowBtn = document.getElementById('add-item')
    const totalNewForms = document.getElementById('id_simpleproduct_set-TOTAL_FORMS')

    const addAccountBtn = document.getElementById('add-account')
    const totalNewAccountForms = document.getElementById('id_purchaserequestaccounts_set-TOTAL_FORMS')

    addAccountBtn.addEventListener('click', add_new_account)
    function add_new_account(event) {
        if (event) {
            event.preventDefault()
        }
        const currentAccountCount = document.getElementById('account-table').rows.length
        const rowCopyTarget = document.getElementById('account-table-body')
        const copyEmptyRow = document.getElementById('empty-account-row').cloneNode(true)
        copyEmptyRow.setAttribute('id','')
        copyEmptyRow.setAttribute('class','account-row')
        const regex = new RegExp('__prefix__', 'g')
        copyEmptyRow.innerHTML = copyEmptyRow.innerHTML.replace(regex, currentAccountCount - 1)
        console.log(currentAccountCount)
        totalNewAccountForms.setAttribute('value',currentAccountCount)
        //console.log(totalNewForms)
        rowCopyTarget.append(copyEmptyRow)
    }

    addRowBtn.addEventListener('click', add_new_item)
    function add_new_item(event) {
        if (event) {
            event.preventDefault()
        }
        const currentItemCount = document.getElementById('item-table').rows.length
        const rowCopyTarget = document.getElementById('item-table-body')
        const copyEmptyRow = document.getElementById('empty-row').cloneNode(true)
        copyEmptyRow.setAttribute('id','')
        copyEmptyRow.setAttribute('class','item-row')
        const regex = new RegExp('__prefix__', 'g')
        copyEmptyRow.innerHTML = copyEmptyRow.innerHTML.replace(regex, currentItemCount - 1)
        console.log(currentItemCount)
        totalNewForms.setAttribute('value',currentItemCount)
        //console.log(totalNewForms)
        rowCopyTarget.append(copyEmptyRow)
    }
</script>

{% endblock %}