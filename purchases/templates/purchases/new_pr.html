{% extends "purchases/layout.html" %}
{% comment %} {% load crispy_forms_tags %} {% endcomment %}
{% load static %}
{% block title %}Create Purchase Request{% endblock %}
{% block content %}

{{ form.media.css }}

<style>
    .hidden {
        display: none
    }

    .currency {
        width: 5em;
    }

    .quantity {
        width: 4em;
    }

    .select-input {
        width: 15em
    }

    .select-account {
        width: 20em
    }

    .select-spendcat {
        width: 12em
    }
</style>

<div class="modal fade" tabindex="-1" role="dialog" id="modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content"></div>>
    </div>
</div>

<div class="container mt-4">
    <form method="post">
        {% csrf_token %}
        <div class="card col">
            <div class="card-header">
                <h4>Create <span class="header-em">Purchase Request</span></h4>
            </div>
            <div class="card-body">
                {{ form.non_form_errors }}
                {% comment %} <p><select class="form-control basicAutoSelect" name="simple_autocomplete" placeholder="type something..." data-url="{% url 'get_autocomp_list' model='requisitioner' %}" autocomplete="off"></select></p> {% endcomment %}
                <table>
                    {{ form.as_table }}
                </table>
                <button id="create-vendor" class="btn btn-primary" type="button" name="button">Create Vendor</button>
                <p class="h1 text-info">Account(s)</p>
                {{ purchase_request_accounts_formset.non_form_errors }}
                {{ purchase_request_accounts_formset.management_form }}
                <table id="account-table" class="table table-striped">
                    <thead class="text-bg-secondary text-center">
                        <td>Account</td>
                        <td>Spend Category</td>
                        <td class="col-2">Dist Type</td>
                        <td class="col-1">Distribution</td>
                        <td>Delete</td>
                    </thead>
                    <tbody id="account-table-body" class="{{ purchase_request_accounts_formset.prefix }}">
                        {% for account in purchase_request_accounts_formset %}
                            {{ account.id }}
                            <tr class="account-row">
                                <td>{{ account.accounts }}</td>
                                <td>{{ account.spend_category }}</td>
                                <td>{{ account.distribution_type }}</td>
                                <td>{{ account.distribution_input }}</td>
                                <td>{{ account.DELETE }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <table class="hidden">
                    <tr id="empty-account-row">
                        {{ purchase_request_accounts_formset.empty_form.id }}
                        <td>{{ purchase_request_accounts_formset.empty_form.accounts }}</td>
                        <td>{{ purchase_request_accounts_formset.empty_form.spend_category }}</td>
                        <td>{{ purchase_request_accounts_formset.empty_form.distribution_type }}</td>
                        <td>{{ purchase_request_accounts_formset.empty_form.distribution_input }}</td>
                        <td>{{ purchase_request_accounts_formset.empty_form.DELETE }}</td>
                    </tr>
                </table>
                <button id="add-account" type="button" class="btn btn-secondary"><i class="fa-solid fa-plus"></i></button>

                {% comment %} <p>Sales Tax: {{ form.sales_tax_rate }}</p> {% endcomment %}
                
                <p class="h1 text-info">Add Items</p>
                {{ purchase_request_items_formset.non_form_errors }}
                {{ purchase_request_items_formset.management_form }}
                <table id="item-table" class="table table-striped">
                    <thead class="text-bg-secondary">
                        <td>Name/Description</td>
                        <td class="col-2">Identifier</td>
                        <td class="col-3">Link</td>
                        <td class="col-1">Unit Price</td>
                        <td class="col-1">Quantity</td>
                        <td class="col-1">Unit</td>
                        <td>Delete</td>
                    </thead>
                    <tbody id="item-table-body" class="{{ purchase_request_items_formset.prefix }}">
                        {% for item in purchase_request_items_formset %}
                            {{ item.non_field_errors }}
                            {{ item.id }}
                            <tr class="item-row">
                                <td>{{ item.name.errors }}{{ item.name }}</td>
                                <td>{{ item.identifier.errors }}{{ item.identifier }}</td>
                                <td>{{ item.link.errors }}{{ item.link }}</td>
                                <td>{{ item.unit_price.errors }}{{ item.unit_price }}</td>
                                <td>{{ item.quantity.errors }}{{ item.quantity }}</td>
                                <td>{{ item.unit.errors }}{{ item.unit }}</td>
                                <td>{{ item.DELETE }}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <table class="hidden">
                    <tr id="empty-row">
                        {{ purchase_request_items_formset.empty_form.id }}
                        <td>{{ purchase_request_items_formset.empty_form.name }}</td>
                        <td>{{ purchase_request_items_formset.empty_form.identifier }}</td>
                        <td>{{ purchase_request_items_formset.empty_form.link }}</td>
                        <td>{{ purchase_request_items_formset.empty_form.unit_price }}</td>
                        <td>{{ purchase_request_items_formset.empty_form.quantity }}</td>
                        <td>{{ purchase_request_items_formset.empty_form.unit }}</td>
                        <td>{{ purchase_request_items_formset.empty_form.DELETE }}</td>
                    </tr>
                </table>
                {% comment %} <button id="add-item" class="btn btn-primary" type="button" name="button">Add Item</button> {% endcomment %}
                {% comment %} <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#exampleModal">Add Item</button> {% endcomment %}
                <button id="add-item" type="button" class="btn btn-secondary"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>
        <div class="mt-3 mb-5">
            <button type="submit" class="save btn btn-primary">Save</button>
        </div>
    </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="{% static 'js/jquery.bootstrap.modal.forms.js' %}"></script>
{{ form.media.js }}

<script>
    const addRowBtn = document.getElementById('add-item')
    const totalNewForms = document.getElementById('id_items-TOTAL_FORMS')

    const addAccountBtn = document.getElementById('add-account')
    const totalNewAccountForms = document.getElementById('id_accounts-TOTAL_FORMS')
    //const tableAccount = document.getElementById('account-table')
    //$('.django-select2').djangoSelect2();

    //const testButton = document.getElementById('test-button')

    addAccountBtn.addEventListener('click', add_new_account)
    function add_new_account(event) {
        if (event) {
            event.preventDefault()
        }
        const currentAccountCount = document.getElementById('account-table').rows.length
        const rowCopyTarget = document.getElementById('account-table-body')
        const copyEmptyRow = document.getElementById('empty-account-row').cloneNode(true)
        copyEmptyRow.setAttribute('id','')
        copyEmptyRow.setAttribute('class','account-row')

        var spans = copyEmptyRow.getElementsByTagName('span');

        /*for (span in spans)
            spans[0].parentNode.removeChild(spans[0])*/

        while (spans[0])
            spans[0].parentNode.removeChild(spans[0])


        const regex = new RegExp('__prefix__', 'g')
        const id_number = currentAccountCount - 1
        copyEmptyRow.innerHTML = copyEmptyRow.innerHTML.replace(regex, id_number)
        console.log(currentAccountCount)
        totalNewAccountForms.setAttribute('value',currentAccountCount)
        //console.log(totalNewForms)
        rowCopyTarget.append(copyEmptyRow)

        /*const newRowSelectId = "id_accounts-" + id_number + '-accounts'
        const newRowSelect = document.getElementById(newRowSelectId)*/
        $('.django-select2').djangoSelect2();
        $('.django-select2').djangoSelect2();
    }

    addRowBtn.addEventListener('click', add_new_item)
    function add_new_item(event) {
        if (event) {
            event.preventDefault()
        }
        const currentItemCount = document.getElementById('item-table').rows.length
        const rowCopyTarget = document.getElementById('item-table-body')
        const copyEmptyRow = document.getElementById('empty-row').cloneNode(true)
        copyEmptyRow.setAttribute('id','')
        copyEmptyRow.setAttribute('class','item-row')
        const regex = new RegExp('__prefix__', 'g')
        copyEmptyRow.innerHTML = copyEmptyRow.innerHTML.replace(regex, currentItemCount - 1)
        console.log(currentItemCount)
        totalNewForms.setAttribute('value',currentItemCount)
        //console.log(totalNewForms)
        rowCopyTarget.append(copyEmptyRow)
    }


    $(document).ready(function() {
        $("#create-vendor").modalForm({
            formURL: "{% url 'modal_create_vendor' %}"
        });
    });
    /*testButton.addEventListener('click', runDjangoSelect2)
    function runDjangoSelect2(event) {
        if (event) {
            event.preventDefault()
        }
        $('.django-select2').djangoSelect2();
    }*/

    {% comment %} $('.basicAutoSelect').autoComplete(); {% endcomment %}
</script>

{% endblock %}